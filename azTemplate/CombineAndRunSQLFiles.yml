# Template for executing all SQL files matching a string search

parameters:
- name: path #$path = "$(System.DefaultWorkingDirectory)\Functions"
  type: string
- name: match #$match = "BASE_*.sql"
  type: string
- name: outPath #$outPath = "$(System.DefaultWorkingDirectory)\Functions"
  type: string
- name: outName #$outName = "BASE.sql"
  type: string

steps:
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo Source Files:
      Get-ChildItem ${{parameters.path}} -include ${{parameters.match}} -rec 
  displayName: 'Files to process: ${{parameters.match}}'
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo Creating: $(System.ArtifactsDirectory)\$(SQLPoolartifactname)\$(Targetfile)
      Get-ChildItem ${{parameters.path}} -include ${{parameters.match}} -rec | ForEach-Object {gc $_; ""} | out-file ${{parameters.outPath}}\${{parameters.outName}}
  displayName: 'Combine: ${{parameters.outName}}'
- task: PublishPipelineArtifact@1
  inputs:
   targetPath: '$(System.ArtifactsDirectory)\$(SQLPoolartifactname)\$(Targetfile)'
   artifact: '${{parameters.outName}}'
   publishLocation: 'pipeline'
  displayName: 'Publish: ${{parameters.outName}}'
# - task: SqlDacpacDeploymentOnMachineGroup@0
#   inputs:
#     TaskType: 'sqlQuery'
#     SqlFile: '${{parameters.outPath}}\${{parameters.outName}}'
#     ServerName: '$(SQL_ServerName).database.windows.net'
#     DatabaseName: '$(SQL_DatabaseName)'
#     AuthScheme: 'sqlServerAuthentication'
#     SqlUsername: '$(SQL_UserName)'
#     SqlPassword: '$(SQL_Password)'
#   displayName: 'Create or Alter: ${{parameters.outName}}'
- task: SqlAzureDacpacDeployment@1
  displayName: 'Install DACPAC on serverless SQL Pool'
  inputs:
    azureSubscription: $(AzureSubscription)
    AuthenticationType: 'server'
    ServerName: $(SQLPoolEndPoint)
    DatabaseName: '$(DestinationDB)'
    SqlUsername: '$(SQLPooluser)'
    SqlPassword: '$(SQLPoolpw)'
    deployType: 'DacpacTask'
    DeploymentAction: 'Publish'
    DacpacFile: '$(System.ArtifactsDirectory)\$(SQLPoolartifactname)\$(Targetfile)'
- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: Remove-Item ${{parameters.path}}\${{parameters.match}} -Recurse
  displayName: 'Delete Files: ${{parameters.match}}' 