trigger:
  - main

pool:
  vmImage: "windows-latest"

variables:
  path: "$(System.DefaultWorkingDirectory)\\Views"
  match: "*.sql"
  outPath: "$(System.DefaultWorkingDirectory)\\Combined\\Functions"
  outName: "UTIL.sql"
  pool:
    vmImage: "windows-latest"
  artifactName: compiledSQL
  artifactLocation: $(System.DefaultWorkingDirectory)

stages:
  - stage: Build
    jobs:
      - template: pipelines/stages/build-stage-sql-artifact.yml
        parameters:
          path: variables.path
          match: variables.match
          outPath: variables.outPath
          outName: variables.outName
          pool: variables.pool
          artifactName: variables.artifactName
          artifactLocation: variables.artifactLocation

  - stage: Deploy
    dependsOn: Build
    condition: succeeded()
    jobs:
      - template: pipelines/stages/deploy-to-serverless-db.yml\
        parameters:
          path: variables.path
          match: variables.match
          outPath: variables.outPath
          outName: variables.outName
          artifactName: variables.artifactName
          artifactLocation: variables.artifactLocation
          pool: variables.pool
